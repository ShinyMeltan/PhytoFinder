// Load PapaParse library externally in <head> for CSV parsing
// <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

(async function() {
  // Helper function to fetch and parse CSV into array of objects
  async function loadCSV(path) {
    const res = await fetch(path);
    const text = await res.text();
    return new Promise((resolve, reject) => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: results => resolve(results.data),
        error: err => reject(err),
      });
    });
  }

  // Load scientific names and common names CSVs
  const scientificData = await loadCSV('data/scientific_names.csv');
  const commonNamesData = await loadCSV('data/Plant_COMMON_NAMES.csv');

  // Build maps:
  // fnfnum -> scientificName
  const fnfnumToScientific = {};
  scientificData.forEach(row => {
    fnfnumToScientific[row.fnfnum] = row.scientific_name;
  });

  // fnfnum -> [common names]
  const fnfnumToCommonNames = {};
  commonNamesData.forEach(row => {
    if (!fnfnumToCommonNames[row.fnfnum]) fnfnumToCommonNames[row.fnfnum] = [];
    fnfnumToCommonNames[row.fnfnum].push(row.common_name);
  });

  // Chemical data (assume preloaded or define here)
  // Here you should have your plantMatrix keyed by fnfnum strings
  // For demo purposes, you can define dummy plantMatrix here or load similarly
  // const plantMatrix = { 'fnfnum1': [...], 'fnfnum2': [...], ... };

  // chemicalList as before
  const chemicalList = [
    "Linalool", "Eugenol", "Camphor", "Thymol",
    "Menthol", "Citral", "Myrcene", "Geraniol",
    "Pinene", "Carvacrol"
  ];

  // For demonstration, dummy plantMatrix (replace with your real data keyed by fnfnum)
  const plantMatrix = {
    '1': [1,1,0,0,0,0,0,0,0,0], // Example fnfnum 1
    '2': [1,0,1,0,0,0,0,0,0,0],
    // ...
  };

  // Build combined searchable list: array of objects
  // Each with { fnfnum, scientificName, commonNames, searchStrings }
  const plants = Object.keys(fnfnumToScientific).map(fnfnum => {
    const sciName = fnfnumToScientific[fnfnum];
    const commonNames = fnfnumToCommonNames[fnfnum] || [];
    // Prepare lowercased search strings
    const searchStrings = [sciName.toLowerCase(), ...commonNames.map(n => n.toLowerCase())];
    return { fnfnum, scientificName: sciName, commonNames, searchStrings };
  });

  const selectedFnfnumbers = [];

  // DOM refs
  const plantSearchInput = document.getElementById("plant-search");
  const suggestionsDiv = document.getElementById("suggestions");
  const selectedPlantsDiv = document.getElementById("selected-plants");

  function renderSelectedPlants() {
    selectedPlantsDiv.innerHTML = "";
    selectedFnfnumbers.forEach(fnfnum => {
      const plantData = plants.find(p => p.fnfnum === fnfnum);
      if (!plantData) return;
      const span = document.createElement("span");
      span.textContent = `${plantData.scientificName} (${plantData.commonNames.join(', ')})`;
      const removeBtn = document.createElement("span");
      removeBtn.textContent = "Ã—";
      removeBtn.className = "remove-plant";
      removeBtn.title = "Remove";
      removeBtn.addEventListener("click", () => {
        const index = selectedFnfnumbers.indexOf(fnfnum);
        if (index > -1) {
          selectedFnfnumbers.splice(index, 1);
          renderSelectedPlants();
        }
      });
      span.appendChild(removeBtn);
      selectedPlantsDiv.appendChild(span);
    });
  }

  let currentMatches = [];
  plantSearchInput.addEventListener("input", () => {
    const query = plantSearchInput.value.trim().toLowerCase();
    if (!query) {
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      currentMatches = [];
      return;
    }

    // Match plants if any searchStrings start with query, exclude selected
    currentMatches = plants.filter(p =>
      p.searchStrings.some(s => s.startsWith(query))
      && !selectedFnfnumbers.includes(p.fnfnum)
    ).slice(0, 5);

    if (currentMatches.length === 0) {
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      return;
    }

    suggestionsDiv.innerHTML = currentMatches.map(p => `<div data-fnfnum="${p.fnfnum}">${p.scientificName} (${p.commonNames.join(', ')})</div>`).join("");
    suggestionsDiv.style.display = "block";
  });

  plantSearchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && currentMatches.length > 0) {
      const fnfnum = currentMatches[0].fnfnum;
      if (!selectedFnfnumbers.includes(fnfnum)) {
        selectedFnfnumbers.push(fnfnum);
        renderSelectedPlants();
      }
      plantSearchInput.value = "";
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      plantSearchInput.focus();
      e.preventDefault();
    }
  });

  suggestionsDiv.addEventListener("click", (e) => {
    if (e.target && e.target.dataset && e.target.dataset.fnfnum) {
      const fnfnum = e.target.dataset.fnfnum;
      if (!selectedFnfnumbers.includes(fnfnum)) {
        selectedFnfnumbers.push(fnfnum);
        renderSelectedPlants();
      }
      plantSearchInput.value = "";
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      plantSearchInput.focus();
    }
  });

  document.addEventListener("click", e => {
    if (!document.getElementById("search-container").contains(e.target)) {
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
    }
  });

  function findSharedChemicals(selectedFnfnumbers) {
    if (selectedFnfnumbers.length === 0) return [];

    let shared = [...plantMatrix[selectedFnfnumbers[0]]];
    for (let i = 1; i < selectedFnfnumbers.length; i++) {
      let current = plantMatrix[selectedFnfnumbers[i]];
      shared = shared.map((bit, idx) => bit & current[idx]);
    }
    return chemicalList.filter((_, i) => shared[i] === 1);
  }

  document.getElementById("find-common").addEventListener("click", () => {
    const commonChemicals = findSharedChemicals(selectedFnfnumbers);

    const resultsDiv = document.getElementById("results");
    if (commonChemicals.length === 0) {
      resultsDiv.textContent = "No common chemicals found among the selected plants.";
    } else {
      resultsDiv.innerHTML = "<h3>Common Chemicals:</h3><ul>" +
        commonChemicals.map(c => `<li>${c}</li>`).join("") +
        "</ul>";
    }
  });
})();
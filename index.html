<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PhytoFinder</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

  body {
    font-family: 'Inter', Arial, sans-serif;
    max-width: 600px;
    margin: 50px auto;
    background-color: #f9faf9;
    color: #2f3e46;
    padding: 0 20px 40px;
  }

  h1 {
    text-align: center;
    font-weight: 300;
    letter-spacing: 1.2px;
    margin-bottom: 0.3em;
    color: #1b4332;
  }

  h2 {
    font-weight: 300;
    letter-spacing: 0.8px;
    color: #344e41;
    margin-bottom: 15px;
  }

  .plants, .results {
    margin-top: 30px;
  }

  label {
    display: block;
    margin: 8px 0;
    cursor: pointer;
    color: #344e41;
  }

  #search-container {
    position: relative;
  }

  #plant-search {
    width: 100%;
    padding: 12px 16px;
    font-size: 1rem;
    box-sizing: border-box;
    border: 1.8px solid #a7c4a0;
    border-radius: 10px;
    outline-offset: 2px;
    outline-color: #6a994e;
    background-color: #f0f5f1;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 1px 4px rgba(106, 153, 78, 0.15);
  }
  #plant-search:focus {
    border-color: #52734d;
    box-shadow: 0 0 8px rgba(82, 115, 77, 0.5);
    background-color: #e6f0e8;
  }

  #suggestions {
    position: absolute;
    top: 110%;
    left: 0;
    right: 0;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    max-height: 180px;
    overflow-y: auto;
    z-index: 1000;
    padding: 8px 0;
  }
  #suggestions div {
    padding: 10px 20px;
    cursor: pointer;
    color: #344e41;
    font-weight: 500;
    transition: background-color 0.25s ease, color 0.25s ease;
  }
  #suggestions div:hover {
    background-color: #d1e7c2;
    color: #1b4332;
  }

  #selected-plants {
    margin-top: 15px;
  }
  #selected-plants span {
    display: inline-flex;
    align-items: center;
    background-color: #a7c4a0;
    border-radius: 9999px;
    padding: 6px 14px;
    margin: 5px 8px 5px 0;
    font-weight: 600;
    color: #1b4332;
    box-shadow: 0 2px 6px rgba(106, 153, 78, 0.3);
    user-select: none;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  #selected-plants span:hover {
    background-color: #8aa46a;
    box-shadow: 0 4px 12px rgba(106, 153, 78, 0.5);
  }
  #selected-plants span .remove-plant {
    margin-left: 10px;
    color: #3a0e0e;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
  }
  #selected-plants span .remove-plant:hover {
    color: #7f1d1d;
  }

  button {
    margin-top: 25px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #f0f5f1;
    background-color: #52734d;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 6px 12px rgba(82, 115, 77, 0.4);
    transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.15s ease;
  }
  button:hover {
    background-color: #3e5c34;
    box-shadow: 0 8px 20px rgba(62, 92, 52, 0.6);
    transform: translateY(-2px);
  }
  button:active {
    transform: translateY(0);
    box-shadow: 0 4px 10px rgba(62, 92, 52, 0.5);
  }

  .results {
    font-weight: 500;
    color: #344e41;
    margin-top: 35px;
  }
  .results h3 {
    font-weight: 400;
    color: #52734d;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
  }
  .results ul {
    padding-left: 20px;
    color: #344e41;
  }
  .results li {
    margin-bottom: 6px;
  }
</style>
</head>
<body>

<h1>PhytoFinder</h1>

<div class="plants">
  <h2>Select Plants</h2>
  <div id="search-container">
    <input type="text" id="plant-search" placeholder="Search plants..." autocomplete="off" />
    <div id="suggestions" style="display:none;"></div>
  </div>
  <div id="selected-plants"></div>
  <button id="find-common">Find Common Chemicals</button>
</div>

<div class="results" id="results"></div>

<script>
  // chemicalList defines the master list of chemicals, in a specific order.
  // Each index in this array corresponds to a column in the plantMatrix.
  const chemicalList = [
    "Linalool", "Eugenol", "Camphor", "Thymol",
    "Menthol", "Citral", "Myrcene", "Geraniol",
    "Pinene", "Carvacrol"
  ];

  // plantMatrix maps each plant to an array of 0s and 1s, where each position
  // corresponds to the presence (1) or absence (0) of the chemical at that index
  // in chemicalList. This acts as a binary "fingerprint" for each plant.
  const plantMatrix = {
    Basil:    [1,1,0,0,0,0,0,0,0,0],
    Lavender: [1,0,1,0,0,0,0,0,0,0],
    Thyme:    [0,0,0,1,0,0,0,0,0,0],
    Mint:     [1,0,0,0,1,0,0,0,0,0],
    Oregano:  [1,0,0,0,0,0,0,0,0,1],
    Rosemary: [0,1,0,0,0,0,0,0,1,0],
    Sage:     [1,0,0,0,0,0,1,0,0,0]
  };

  const plants = Object.keys(plantMatrix);
  const selectedPlants = [];

  const plantSearchInput = document.getElementById("plant-search");
  const suggestionsDiv = document.getElementById("suggestions");
  const selectedPlantsDiv = document.getElementById("selected-plants");

  function renderSelectedPlants() {
    selectedPlantsDiv.innerHTML = "";
    selectedPlants.forEach(plant => {
      const span = document.createElement("span");
      span.textContent = plant;
      const removeBtn = document.createElement("span");
      removeBtn.textContent = "×";
      removeBtn.className = "remove-plant";
      removeBtn.title = "Remove";
      removeBtn.addEventListener("click", () => {
        const index = selectedPlants.indexOf(plant);
        if (index > -1) {
          selectedPlants.splice(index, 1);
          renderSelectedPlants();
        }
      });
      span.appendChild(removeBtn);
      selectedPlantsDiv.appendChild(span);
    });
  }

  // currentMatches holds the filtered list of plant search suggestions
  // that match the user's input and are not already selected.
  let currentMatches = [];
  plantSearchInput.addEventListener("input", () => {
    const query = plantSearchInput.value.trim().toLowerCase();
    if (!query) {
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      currentMatches = [];
      return;
    }

    // Filter plants by input query, excluding those already selected.
    currentMatches = plants.filter(plant => plant.toLowerCase().startsWith(query) && !selectedPlants.includes(plant)).slice(0, 5);

    if (currentMatches.length === 0) {
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      return;
    }

    // Render suggestions as clickable divs.
    suggestionsDiv.innerHTML = currentMatches.map(plant => `<div>${plant}</div>`).join("");
    suggestionsDiv.style.display = "block";
  });

  // Allow selecting the first suggestion by pressing Enter.
  plantSearchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && currentMatches && currentMatches.length > 0) {
      const selectedPlant = currentMatches[0];
      if (!selectedPlants.includes(selectedPlant)) {
        selectedPlants.push(selectedPlant);
        renderSelectedPlants();
      }
      // Clear search and hide suggestions
      plantSearchInput.value = "";
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      plantSearchInput.focus();
      // Prevent form submission or default Enter behavior
      e.preventDefault();
    }
  });

  // Handle clicking a suggestion to select a plant.
  suggestionsDiv.addEventListener("click", (e) => {
    if (e.target && e.target.nodeName === "DIV") {
      const selectedPlant = e.target.textContent;
      if (!selectedPlants.includes(selectedPlant)) {
        selectedPlants.push(selectedPlant);
        renderSelectedPlants();
      }
      // Clear search and hide suggestions
      plantSearchInput.value = "";
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
      plantSearchInput.focus();
    }
  });

  // Hide suggestions if clicking outside the search container.
  document.addEventListener("click", (e) => {
    if (!document.getElementById("search-container").contains(e.target)) {
      suggestionsDiv.style.display = "none";
      suggestionsDiv.innerHTML = "";
    }
  });

  /**
   * Finds chemicals shared by all selected plants.
   * For each chemical (by index), checks if all selected plants have a 1 for that chemical.
   * Uses bitwise intersection: ANDs each plant's chemical array together,
   * resulting in 1 only where all selected plants have 1.
   * Filters chemicalList to include only chemicals present in all selected plants.
   *
   * @param {string[]} selectedPlants - Array of selected plant names.
   * @returns {string[]} Array of chemical names present in all selected plants.
   */
  function findSharedChemicals(selectedPlants) {
    if (selectedPlants.length === 0) return [];

    // Start with the chemical array of the first plant.
    let shared = [...plantMatrix[selectedPlants[0]]];
    // For each subsequent plant, perform a bitwise AND for each chemical.
    for (let i = 1; i < selectedPlants.length; i++) {
      let current = plantMatrix[selectedPlants[i]];
      shared = shared.map((bit, idx) => bit & current[idx]);
    }
    // Return chemical names where the resulting shared array has a 1.
    return chemicalList.filter((_, i) => shared[i] === 1);
  }

  // When the user clicks the "Find Common Chemicals" button,
  // calculate and display the shared chemicals among the selected plants.
  document.getElementById("find-common").addEventListener("click", () => {
    const commonChemicals = findSharedChemicals(selectedPlants);

    const resultsDiv = document.getElementById("results");
    if (commonChemicals.length === 0) {
      resultsDiv.textContent = "No common chemicals found among the selected plants.";
    } else {
      resultsDiv.innerHTML = "<h3>Common Chemicals:</h3><ul>" +
        commonChemicals.map(c => `<li>${c}</li>`).join("") +
        "</ul>";
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const plantData = {};

  Papa.parse("data/scientific_names.csv", {
    download: true,
    header: true,
    complete: (results) => {
      results.data.forEach(entry => {
        const fnf = Number(entry.FNFNUM);
        plantData[fnf] = {
          scientific: `${entry.Genus} ${entry.Species}`,
          common: [] // we’ll fill this in next
        };
      });
      console.log("Loaded plantData from CSV:", plantData);
    }
  });
</script>